package Network;

import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.net.Socket;

import javax.swing.JOptionPane;

import GamePanel.LoadingThread;
import GamePanel.MainPanel;

public class GameClient {

	public ObjectOutputStream toServer;
	public ObjectInputStream fromServer;
	public Socket socket;
	public String clientId;
	public MainPanel mp;
	public int clientNumber;		// 클라이언트 캐릭터 번호
	public String teamColor="";		// 팀 칼라
	public LoadingThread loadthread;

	
	public GameClient(MainPanel mp) {
		this.mp = mp;
	}

	// 한개에 프로그램에 접속하는 것으로 고정아이피, 고정포트넘버사용
	public boolean connect() {
		try {
			socket = new Socket("192.168.2.4", 1234);
			System.out.println("Server Connectted");
			return true;
		} catch (IOException e) {
			e.printStackTrace();
		}
		return false;
	}

	public void streamOpen() {
		try {
			this.toServer = new ObjectOutputStream(socket.getOutputStream());
			this.fromServer = new ObjectInputStream(socket.getInputStream());
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	public boolean loginSend(ClientData cData) {

		boolean loginOk = false;
		String str = null;
		try {
			toServer.reset();
			toServer.writeObject(cData);
			toServer.flush();

			cData = (ClientData) fromServer.readObject();
		} catch (Exception e) {
			e.printStackTrace();
		}
		// team 인원수 파악 및 로그인 성공
		if (cData.isLoginOK()) {
			loginOk = true;
			clientId = cData.getUserId();
			teamColor = cData.getTeamColor();		// 서버로부터 팀 배정
			clientNumber = cData.getTeamNum();		// 서버로부터 팀순번 배정
			
	//클라이언트 화면을 로딩화면으로 전환한다. - 쓰레드 활용
			loadthread = new LoadingThread(mp);
			loadthread.start();
			
			
			str = String.format("Red Team : %d/3\nBlue Team: %d/3", cData.getClientRedNum(), cData.getClientBlueNum());
			JOptionPane.showMessageDialog(mp, str);
			new ClientComThread(socket, mp, this).start();
			System.out.println("클라이언트받았고 클라 쓰레드 시작");
			//들어온 인원수를 제한한다.	블루 1/ 레드 1
			if (cData.getClientBlueNum() == 3 && cData.getClientRedNum() == 3) {

				try {
					// 모든 팀원들이 들어와서 모두 매칭되었다. 서버로 신호를 보냄 -> 서버에서 다시 모든 클라이언트로 값을
					// 보내어 게임에 입장하도록 함.
					cData.setAllTeamOK(true);
					toServer.reset();
					toServer.writeObject(cData);
					toServer.flush();
				} catch (IOException e) {
					e.printStackTrace();
				}

			}
		} else if (cData.isLoginOK()) {
			str = String.format("Red Team : %d/3\nBlue Team: %d/3", cData.getClientRedNum(), cData.getClientBlueNum());
			JOptionPane.showMessageDialog(mp, str);
			loginOk = false;
		}
		return loginOk;

	}

	// Chatting sending
	public void sendMessage(GameData gData) {

		gData.setUserID(clientId);
		try {
			toServer.reset(); 
			toServer.writeObject(gData);
			toServer.flush();
		} catch (IOException e) {
			e.printStackTrace();
		}

	}

	// 게임 데이터를 보낸다.
	public void sendGameData(GameData gData) {
		try {
			toServer.reset();
			toServer.writeObject(gData);
			toServer.flush();
		} catch (IOException e) {
			e.printStackTrace();
		}

	}
	public void sendGamePointData(PointData gData) {
		try {
			toServer.reset();
			toServer.writeObject(gData);
			toServer.flush();
		} catch (IOException e) {
			e.printStackTrace();
		}

	}
	
	

}
